{% assign gen_id = section.id | replace: '_', '' | downcase %}

{% style %}
  .featured-collection-{{ gen_id }} {
    padding: 40px 20px;
    background-color: {{ section.settings.background_color }};
  }

  .featured-collection__container-{{ gen_id }} {
    max-width: 1200px;
    margin: 0 auto;
  }

  .featured-collection__header-{{ gen_id }} {
    text-align: center;
    margin-bottom: 40px;
  }

  .featured-collection__title-{{ gen_id }} {
    font-size: {{ section.settings.heading_size }}px;
    color: {{ section.settings.heading_color }};
    margin: 0 0 10px;
  }

  .featured-collection__description-{{ gen_id }} {
    font-size: {{ section.settings.description_size }}px;
    color: {{ section.settings.text_color }};
    margin: 0;
  }

  .featured-collection__grid-{{ gen_id }} {
    display: grid;
    grid-template-columns: repeat({{ section.settings.products_per_row }}, 1fr);
    gap: {{ section.settings.grid_gap }}px;
  }

  .featured-collection__product-{{ gen_id }} {
    display: flex;
    flex-direction: column;
  }

  .featured-collection__image-wrapper-{{ gen_id }} {
    position: relative;
    width: 100%;
    padding-bottom: 100%;
    overflow: hidden;
    border-radius: {{ section.settings.image_border_radius }}px;
    background-color: #f4f4f4;
    margin-bottom: 12px;
  }

  .featured-collection__image-{{ gen_id }} {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: opacity 0.3s ease;
  }

  .featured-collection__image-{{ gen_id }}.hidden {
    opacity: 0;
  }

  .featured-collection__product-info-{{ gen_id }} {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .featured-collection__product-title-{{ gen_id }} {
    font-size: 16px;
    color: {{ section.settings.text_color }};
    margin: 0;
    text-decoration: none;
  }

  .featured-collection__product-title-{{ gen_id }}:hover {
    text-decoration: underline;
  }

  .featured-collection__product-price-{{ gen_id }} {
    font-size: 14px;
    color: {{ section.settings.text_color }};
  }

  .featured-collection__swatches-{{ gen_id }} {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .featured-collection__swatch-{{ gen_id }} {
    width: {{ section.settings.swatch_size }}px;
    height: {{ section.settings.swatch_size }}px;
    border-radius: 50%;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
  }

  .featured-collection__swatch-{{ gen_id }}:hover {
    transform: scale(1.1);
  }

  .featured-collection__swatch-{{ gen_id }}.active {
    border: 1px dashed orange;
  }

  .featured-collection__empty-state-{{ gen_id }} {
    text-align: center;
    padding: 60px 20px;
    color: #999;
  }

  @media screen and (max-width: 989px) {
    .featured-collection__grid-{{ gen_id }} {
      grid-template-columns: repeat({{ section.settings.products_per_row_tablet }}, 1fr);
    }
  }

  @media screen and (max-width: 749px) {
    .featured-collection__grid-{{ gen_id }} {
      grid-template-columns: repeat({{ section.settings.products_per_row_mobile }}, 1fr);
    }

    .featured-collection__title-{{ gen_id }} {
      font-size: calc({{ section.settings.heading_size }}px * 0.8);
    }
  }
{% endstyle %}

<featured-collection-{{ gen_id }}
  class="featured-collection-{{ gen_id }}"
  {{ section.shopify_attributes }}
>
  <div class="featured-collection__container-{{ gen_id }}">
    {% if section.settings.heading != blank or section.settings.description != blank %}
      <div class="featured-collection__header-{{ gen_id }}">
        {% if section.settings.heading != blank %}
          <h2 class="featured-collection__title-{{ gen_id }}">{{ section.settings.heading }}</h2>
        {% endif %}
        {% if section.settings.description != blank %}
          <div class="featured-collection__description-{{ gen_id }}">{{ section.settings.description }}</div>
        {% endif %}
      </div>
    {% endif %}

    {% if section.settings.collection != blank %}
      <div class="featured-collection__grid-{{ gen_id }}">
        {% for product in section.settings.collection.products limit: section.settings.products_to_show %}
          <div class="featured-collection__product-{{ gen_id }}" data-product-id="{{ product.id }}">
            <a href="{{ product.url }}" class="featured-collection__image-wrapper-{{ gen_id }}">
              {% if product.featured_image %}
                <img
                  src="{{ product.featured_image | image_url: width: 600 }}"
                  alt="{{ product.featured_image.alt | escape }}"
                  loading="lazy"
                  width="600"
                  height="600"
                  class="featured-collection__image-{{ gen_id }}"
                  data-variant-image
                  data-default-image="{{ product.featured_image | image_url: width: 600 }}"
                >
              {% else %}
                <div class="featured-collection__image-placeholder-{{ gen_id }}">
                  {{ 'product-1' | placeholder_svg_tag }}
                </div>
              {% endif %}
            </a>

            <div class="featured-collection__product-info-{{ gen_id }}">
              <a href="{{ product.url }}" class="featured-collection__product-title-{{ gen_id }}">
                {{ product.title }}
              </a>

              <div class="featured-collection__product-price-{{ gen_id }}">
                {{ product.price | money }}
              </div>

              {% assign color_option = null %}
              {% for option in product.options_with_values %}
                {% assign option_name_downcase = option.name | downcase %}
                {% if option_name_downcase == 'color' or option_name_downcase == 'colour' %}
                  {% assign color_option = option %}
                  {% break %}
                {% endif %}
              {% endfor %}

              {% if color_option and color_option.values.size > 1 %}
                <div class="featured-collection__swatches-{{ gen_id }}" data-swatches>
                  {% for value in color_option.values %}
                    {% assign variant_for_value = null %}
                    {% for variant in product.variants %}
                      {% if variant.options contains value %}
                        {% assign variant_for_value = variant %}
                        {% break %}
                      {% endif %}
                    {% endfor %}

                    {% if variant_for_value %}
                      {% assign color_value_handle = value | handleize %}
                      {% assign swatch_color = section.settings[color_value_handle] %}
                      
                      {% unless swatch_color %}
                        {% assign swatch_color = value | downcase | replace: ' ', '' %}
                      {% endunless %}

                      <button
                        class="featured-collection__swatch-{{ gen_id }} {% if forloop.first %}active{% endif %}"
                        style="background-color: {{ swatch_color }};"
                        data-variant-id="{{ variant_for_value.id }}"
                        data-variant-image="{% if variant_for_value.featured_image %}{{ variant_for_value.featured_image | image_url: width: 600 }}{% endif %}"
                        aria-label="{{ value }}"
                        title="{{ value }}"
                      ></button>
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="featured-collection__empty-state-{{ gen_id }}">
        <p>Next, select a collection to display products</p>
      </div>
    {% endif %}
  </div>
</featured-collection-{{ gen_id }}>

<script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, looking for featured collection');
    
    const featuredCollection = document.querySelector('.featured-collection-{{ gen_id }}');
    if (!featuredCollection) {
      console.log('Featured collection not found');
      return;
    }
    
    console.log('Featured collection found, setting up swatches');
    
    const products = featuredCollection.querySelectorAll('.featured-collection__product-{{ gen_id }}');
    console.log('Found products:', products.length);
    
    products.forEach((product, productIndex) => {
      const swatches = product.querySelectorAll('.featured-collection__swatch-{{ gen_id }}');
      const image = product.querySelector('[data-variant-image]');
      const defaultImage = image ? image.dataset.defaultImage : null;
      
      console.log(`Product ${productIndex}: ${swatches.length} swatches found`);

      swatches.forEach((swatch, swatchIndex) => {
        swatch.addEventListener('click', function(e) {
          console.log(`Swatch ${swatchIndex} clicked on product ${productIndex}`);
          e.preventDefault();
          e.stopPropagation();
          
          // Remove active from all swatches in this product
          swatches.forEach(s => s.classList.remove('active'));
          
          // Add active to clicked swatch
          swatch.classList.add('active');
          console.log('Active class toggled');

          // Handle image switching
          if (image) {
            const variantImage = swatch.dataset.variantImage;
            console.log('Variant image:', variantImage);
            
            if (variantImage && variantImage.trim() !== '') {
              image.classList.add('hidden');
              
              setTimeout(() => {
                image.src = variantImage;
                image.classList.remove('hidden');
                console.log('Image switched to:', variantImage);
              }, 150);
            } else if (defaultImage) {
              image.classList.add('hidden');
              
              setTimeout(() => {
                image.src = defaultImage;
                image.classList.remove('hidden');
                console.log('Image switched to default');
              }, 150);
</script>

{% schema %}
{
  "name": "Collection with swatches",
  "tag": "section",
  "settings": [
    {
      "type": "header",
      "content": "Collection"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 2,
      "max": 12,
      "step": 1,
      "label": "Products to show",
      "default": 4
    },
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "inline_richtext",
      "id": "heading",
      "label": "Heading",
      "default": "Featured collection"
    },
    {
      "type": "inline_richtext",
      "id": "description",
      "label": "Description"
    },
    {
      "type": "range",
      "id": "heading_size",
      "min": 16,
      "max": 48,
      "step": 2,
      "unit": "px",
      "label": "Heading size",
      "default": 32
    },
    {
      "type": "range",
      "id": "description_size",
      "min": 12,
      "max": 24,
      "step": 1,
      "unit": "px",
      "label": "Description size",
      "default": 16
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "products_per_row",
      "min": 2,
      "max": 5,
      "step": 1,
      "label": "Products per row (desktop)",
      "default": 4
    },
    {
      "type": "range",
      "id": "products_per_row_tablet",
      "min": 2,
      "max": 4,
      "step": 1,
      "label": "Products per row (tablet)",
      "default": 3
    },
    {
      "type": "select",
      "id": "products_per_row_mobile",
      "label": "Products per row (mobile)",
      "options": [
        {
          "value": "1",
          "label": "1"
        },
        {
          "value": "2",
          "label": "2"
        }
      ],
      "default": "2"
    },
    {
      "type": "range",
      "id": "grid_gap",
      "min": 8,
      "max": 40,
      "step": 4,
      "unit": "px",
      "label": "Grid gap",
      "default": 20
    },
    {
      "type": "range",
      "id": "image_border_radius",
      "min": 0,
      "max": 40,
      "step": 2,
      "unit": "px",
      "label": "Image border radius",
      "default": 8
    },
    {
      "type": "header",
      "content": "Color swatches"
    },
    {
      "type": "paragraph",
      "content": "Swatches will automatically appear for products with a Color option. Customize swatch colors below or they will use the color name as the background."
    },
    {
      "type": "range",
      "id": "swatch_size",
      "min": 20,
      "max": 40,
      "step": 2,
      "unit": "px",
      "label": "Swatch size",
      "default": 28
    },
    {
      "type": "color",
      "id": "swatch_active_border",
      "label": "Active swatch border",
      "default": "#473f21"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background",
      "default": "#fffaec"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading",
      "default": "#473f21"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text",
      "default": "#473f21"
    }
  ],
  "presets": [
    {
      "name": "Collection with swatches"
    }
  ]
}
{% endschema %}
